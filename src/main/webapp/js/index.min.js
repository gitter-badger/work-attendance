$(function(){getUser();initTip();addYearOption();addMonthOption();addCheckbox();initData()});function getUser(){$.ajax({url:"rest/login/user?_="+new Date().getTime(),method:"get",dataType:"json"}).done(function(a){$(".user-name").text(a.waUserName)})}function initTip(){$(".wa-user-area .sign.icon").popup().click(function(){$.ajax({url:"rest/login/logout?_="+new Date().getTime(),method:"get"}).done(function(){window.location.reload()})});$(".wa-user-area .share.icon").popup().click(function(){window.open("http://124.42.1.13:8000/iclock/accounts/login/");})}var isComplete=false;var intervalNum;function initData(){updateData();intervalNum=setInterval("prepareLoadData()",100)}function updateData(){$.ajax({url:"rest/data/update?_="+new Date().getTime(),method:"get",dataType:"json"}).done(function(a){console.log(a);isComplete=true}).fail(function(b,a){console.log(a);isComplete=true})}function prepareLoadData(){if(isComplete){clearInterval(intervalNum);loadData()}}function loadData(a){$.ajax({url:"rest/data/month?qdate="+(a?a:"")+"&_="+new Date().getTime(),method:"get",dataType:"json"}).done(function(b){fillHoliday(b);fillTable(b);fillAanalysis()}).fail(function(c,b){console.log(b)})}function fillTable(g){var d=g.status;var a=$("#record-table").find("tbody");if(d=="1"){a.html("").append(tableTipTemplate("从精友考勤网站获取数据失败，请刷新页面！"))}else{if(d=="2"){a.html("").append(tableTipTemplate("未查找到考勤记录！"))}else{var c=g.recordList;$("input[name='record-size']").val(c.length);var f="";for(var e=0;e<c.length;e++){var b=c[e].waState;var h="";if(b=="0"){h="hidden"}else{if(b=="5"){h="positive"}else{if(b!="1"){h="negative"}}}f+="<tr class='"+h+"'>";f+="<td>"+parseDefaultValue(c[e].waDate)+"</td>";f+="<td>"+parseDefaultValue(c[e].waWeek)+"</td>";f+="<td>"+parseDefaultValue(c[e].waType)+"</td>";f+="<td>"+parseDefaultValue(c[e].waValidateWay)+"</td>";f+="<td>"+parseDefaultValue(c[e].waDevice)+"</td>";f+="<td><input type='hidden' name='wastate' value='"+c[e].waState+"'>"+getStateName(c[e].waState)+"</td>";f+="</tr>"}a.html(f)}}}function fillHoliday(b){$(".wa-holiday .list").html("");var c=b.holidayList;if(c&&c.length>0){for(var a=0;a<c.length;a++){$(".wa-holiday .list").append(holidayTemplate(c[a].holidayName,c[a].holidayDesc))}}}function fillAanalysis(){var d=$("#record-table").find("tbody");var f=0,k=0,e=0,i=0,g=0;var h,b,c,a,j;d.find("tr:visible").each(function(){var l=$(this).find("input[name='wastate']").val();switch(l){case"2":f++;break;case"3":k++;break;case"4":i++;break;case"5":g++;break;case"6":e++;break}});if(f>0){if(f>3){h='迟到<a class="ui mini red circular label">'+f+"</a>次，已经超过3次了，请补"+(f-3)+"个单子吧"}else{if(f==3){h='迟到<a class="ui mini red circular label">'+f+"</a>次，你已经没有迟到机会了"}else{h='迟到<a class="ui mini red circular label">'+f+"</a>次，剩下"+(3-f)+"次机会要省着点用"}}$(".list .late").html(h)}else{$(".list .late").html("迟到有3条命")}if(k>0){b='早退<a class="ui mini red circular label">'+k+"</a>次，月底前记得补单子";$(".list .early").html(b)}else{$(".list .early").html("对你的调休说bye bye")}if(e>0){c='忘打卡<a class="ui mini red circular label">'+e+"</a>次，1次1小时，1小时1次";$(".list .forget").html(c)}else{$(".list .forget").html("没的说，调休1小时")}if(i>0){a='旷工<a class="ui mini red circular label">'+i+"</a>天，不管是请假还是外出都得填单子";$(".list .absenteeism").html(a)}else{$(".list .absenteeism").html("外出？请假？")}if(g>0){j='加班<a class="ui mini green circular label">'+(g/2)+"</a>天，加了多少小时的班自己算";$(".list .overtime").html(j)}else{$(".list .overtime").html("又可以愉快的请请请了")}}function parseDefaultValue(a){if(!a){a="（空）"}return a}function getStateName(a){switch(a){case"0":return"正常";case"1":return"正常";case"2":return"迟到";case"3":return"早退";case"4":return"旷工";case"5":return"加班";case"6":return"忘打卡"}}var date=new Date();function addYearOption(){var c="";for(var a=4;a>=0;a--){var b=date.getFullYear()-a;c+="<option "+(a==0?"selected":"")+" value='"+b+"'>"+b+"年</option>"}$("#year").html(c).dropdown({onChange:function(e,f,d){dropdownChangeEvent(e,1)}})}function addMonthOption(){var c="";var d=date.getMonth()+1;for(var b=1;b<13;b++){var a=b<10?("0"+b):b;c+="<option "+(d==b?"selected":"")+" value='"+a+"'>"+a+"月</option>"}$("#month").html(c).dropdown({onChange:function(f,g,e){dropdownChangeEvent(f,2)}})}function dropdownChangeEvent(c,a){var b,d;if(a==1){b=c;d=$("#month").closest(".dropdown").find(".selected").attr("data-value")}else{b=$("#year").closest(".dropdown").find(".selected").attr("data-value");d=c}$(".ui.checkbox").checkbox("set unchecked");loadData(b+"-"+d)}function addCheckbox(){$(".ui.checkbox").checkbox({onChecked:function(){var b=$(this).closest(".checkbox");var d=b.prop("id");var c=$("input[name='record-size']").val();$(".ui.checkbox").checkbox("set unchecked");b.checkbox("set checked");if(c>0){var a=$("#record-table > tbody");if(d=="all"){a.find("tr").show()}else{if(d=="exception"){a.find("tr[class='negative']").show();a.find("tr[class!='negative']").hide()}else{a.find("tr[class='positive']").show();a.find("tr[class!='positive']").hide()}}if(a.find("tr:visible").length==0){a.append(tableTipTemplate("没有匹配数据"))}else{a.find("tr[class='no-data']").remove()}}},onUnchecked:function(){var a=$("#record-table > tbody");a.find("tr[class!='hidden']").show();a.find("tr[class='hidden']").hide();a.find("tr[class='no-data']").remove()}})}function holidayTemplate(a,b){return'<div class="item">'+'<i class="big calendar middle aligned icon"></i>'+'<div class="content">'+'<a class="header">'+a+"</a>"+'<div class="description">'+b+"</div>"+"</div>"+"</div>"}function tableTipTemplate(a){return"<tr class='no-data'><td colspan='6'>"+a+"</td></tr>"};